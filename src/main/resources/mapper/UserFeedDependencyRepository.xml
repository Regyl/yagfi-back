<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.regyl.gfi.repository.UserFeedDependencyRepository">

    <insert id="saveAll">
        INSERT INTO gfi.e_user_feed_dependency (request_id, source_repo, dependency_url, created)
        VALUES
        <foreach collection="entities" item="entity" separator=",">
            (#{entity.requestId}, #{entity.sourceRepo}, #{entity.dependencyUrl}, COALESCE(#{entity.created}, NOW()))
        </foreach>
        ON CONFLICT (source_repo, dependency_url) DO NOTHING
    </insert>

    <select id="findSourceRepoStatisticsByRequestId" resultType="com.github.regyl.gfi.controller.dto.response.feed.SourceRepoStatisticResponseDto">
        SELECT
            source_repo as sourceRepo,
            count(1) as count
        FROM gfi.e_user_feed_dependency
        WHERE request_id = #{requestId}
        GROUP BY source_repo
        ORDER BY count(1) DESC
    </select>

</mapper>
