<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.regyl.gfi.repository.UserFeedDependencyRepository">

    <resultMap id="IssueResponseResultMap" type="com.github.regyl.gfi.dto.response.issue.IssueResponseDto">
        <result property="issueId" column="issueId"/>
        <result property="issueTitle" column="issueTitle"/>
        <result property="issueUrl" column="issueUrl"/>
        <result property="issueUpdated" column="issueUpdated"/>
        <result property="issueCreated" column="issueCreated"/>
        <result property="issueLabels" column="issueLabels" typeHandler="com.github.regyl.gfi.typehandler.StringListTypeHandler"/>
        <result property="issueLanguage" column="issueLanguage"/>
        <result property="repositoryTitle" column="repositoryTitle"/>
        <result property="repositoryUrl" column="repositoryUrl"/>
        <result property="repositoryStars" column="repositoryStars"/>
        <result property="repositoryDescription" column="repositoryDescription"/>
        <result property="repositoryLanguage" column="repositoryLanguage"/>
        <result property="repositoryLicense" column="repositoryLicense"/>
    </resultMap>

    <insert id="saveAll">
        INSERT INTO gfi.e_user_feed_dependency (request_id, source_repo, dependency_url, created)
        VALUES
        <foreach collection="entities" item="entity" separator=",">
            (#{entity.requestId}, #{entity.sourceRepo}, #{entity.dependencyUrl}, COALESCE(#{entity.created}, NOW()))
        </foreach>
        ON CONFLICT (source_repo, dependency_url) DO NOTHING
    </insert>

    <select id="findSourceRepoStatisticsByRequestId" resultType="com.github.regyl.gfi.dto.response.feed.SourceRepoStatisticResponseDto">
        SELECT
            e_dep.source_repo AS sourceRepo,
            e_dep.dependency_url AS dependencyUrl,
            count(iv.id) AS issueCnt,
            rv.stars AS stars
        FROM gfi.e_user_feed_dependency e_dep
        LEFT JOIN gfi.repository_v rv ON e_dep.dependency_url = rv.url
        LEFT JOIN gfi.issue_v iv ON rv.id = iv.repository_id
        WHERE e_dep.request_id = #{requestId}
        GROUP BY e_dep.source_repo, e_dep.dependency_url, rv.stars
        ORDER BY rv.stars DESC NULLS LAST
    </select>

    <select id="findIssuesBySourceRepo" resultMap="IssueResponseResultMap">
        WITH idk AS (
            SELECT DISTINCT dependency_url
            FROM gfi.e_user_feed_dependency
            WHERE source_repo = #{sourceRepo}
        )
        SELECT
            iv.id AS issueId,
            iv.title AS issueTitle,
            iv.url AS issueUrl,
            iv.updated_at AS issueUpdated,
            iv.created_at AS issueCreated,
            iv.labels AS issueLabels,
            iv.language AS issueLanguage,
            rv.title AS repositoryTitle,
            rv.url AS repositoryUrl,
            rv.stars AS repositoryStars,
            rv.description AS repositoryDescription,
            rv.language AS repositoryLanguage,
            rv.license AS repositoryLicense
        FROM gfi.issue_v iv
        INNER JOIN gfi.repository_v rv ON iv.repository_id = rv.id
        INNER JOIN idk ON idk.dependency_url = rv.url
        order by iv.created_at desc
    </select>

    <select id="findIssuesByRequestId" resultMap="IssueResponseResultMap">
        WITH idk AS (
            SELECT DISTINCT dependency_url
            FROM gfi.e_user_feed_dependency
            WHERE request_id = #{requestId}
        )
        SELECT
            iv.id AS issueId,
            iv.title AS issueTitle,
            iv.url AS issueUrl,
            iv.updated_at AS issueUpdated,
            iv.created_at AS issueCreated,
            iv.labels AS issueLabels,
            iv.language AS issueLanguage,
            rv.title AS repositoryTitle,
            rv.url AS repositoryUrl,
            rv.stars AS repositoryStars,
            rv.description AS repositoryDescription,
            rv.language AS repositoryLanguage,
            rv.license AS repositoryLicense
        FROM gfi.issue_v iv
        INNER JOIN gfi.repository_v rv ON iv.repository_id = rv.id
        INNER JOIN idk ON idk.dependency_url = rv.url
        order by iv.created_at desc
    </select>

</mapper>
